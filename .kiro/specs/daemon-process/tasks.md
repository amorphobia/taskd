# TaskD 守护进程实现任务列表

## 阶段1：基础架构搭建

### 1.1 数据结构扩展
- [x] 1.1.1 扩展 Config 结构体，添加 MaxRetryNum 字段
- [x] 1.1.2 扩展 TaskRuntimeInfo 结构体，添加 StoppedByTaskd 和 RetryNum 字段
- [x] 1.1.3 创建 DaemonStatus 结构体定义守护进程状态
- [x] 1.1.4 创建 ProcessStatus 结构体定义进程检查结果

### 1.2 命令行参数处理
- [x] 1.2.1 在 root.go 中添加 --daemon 隐藏参数
- [x] 1.2.2 实现 --daemon 参数验证逻辑，禁止与其他参数组合使用
- [x] 1.2.3 在 main.go 中添加守护进程模式入口点
- [x] 1.2.4 实现守护进程模式的信号处理机制

### 1.3 内置任务处理器
- [x] 1.3.1 创建 BuiltinTaskHandler 结构体
- [x] 1.3.2 实现 IsBuiltinTask 方法检查内置任务
- [x] 1.3.3 实现 GetBuiltinTaskConfig 方法返回虚拟配置
- [x] 1.3.4 实现 ValidateOperation 方法限制内置任务操作
- [x] 1.3.5 在任务管理器中集成内置任务处理逻辑

## 阶段2：守护进程管理

### 2.1 守护进程管理器
- [x] 2.1.1 创建 DaemonManager 结构体
- [x] 2.1.2 实现 StartDaemon 方法启动守护进程
- [x] 2.1.3 实现 StopDaemon 方法停止守护进程
- [x] 2.1.4 实现 IsRunning 方法检查守护进程状态
- [x] 2.1.5 实现 EnsureDaemonRunning 方法自动启动守护进程

### 2.2 进程状态检测
- [x] 2.2.1 创建 ProcessChecker 结构体
- [x] 2.2.2 实现 CheckTaskProcess 方法检查进程存在性
- [x] 2.2.3 实现进程可执行文件路径验证
- [x] 2.2.4 实现进程退出状态获取（Windows 平台）
- [x] 2.2.5 处理 PID 重用检测逻辑

### 2.3 守护进程状态管理
- [x] 2.3.1 实现守护进程状态的持久化存储
- [x] 2.3.2 实现守护进程启动时的状态更新
- [x] 2.3.3 实现守护进程停止时的状态清理
- [x] 2.3.4 实现守护进程状态的读取和验证

## 阶段3：任务监控机制

### 3.1 任务监控器
- [x] 3.1.1 创建 TaskMonitor 结构体
- [x] 3.1.2 实现监控循环的启动和停止
- [x] 3.1.3 实现定时任务状态检查逻辑
- [x] 3.1.4 实现任务进程退出检测
- [x] 3.1.5 实现任务状态更新机制

### 3.2 自动重启逻辑
- [x] 3.2.1 实现 shouldRetryTask 函数判断重启条件
- [x] 3.2.2 实现任务自动重启执行逻辑
- [x] 3.2.3 实现重试计数的递增和重置
- [x] 3.2.4 实现重试上限检查和停止逻辑
- [x] 3.2.5 实现重启失败的错误处理

### 3.3 状态同步机制
- [x] 3.3.1 创建 StateUpdater 接口定义
- [x] 3.3.2 实现 FileStateManager 文件状态管理器
- [x] 3.3.3 实现状态文件的原子性更新
- [x] 3.3.4 实现状态文件的并发访问控制
- [x] 3.3.5 实现状态文件损坏时的恢复机制

## 阶段4：命令集成

### 4.1 自动启动机制集成
- [x] 4.1.1 在 start 命令中集成守护进程自动启动
- [x] 4.1.2 在 stop 命令中集成 StoppedByTaskd 标记设置
- [x] 4.1.3 在 restart 命令中集成重试计数重置
- [x] 4.1.4 在 list 命令中集成守护进程状态检查
- [x] 4.1.5 在 info 命令中集成守护进程状态检查

### 4.2 内置任务命令支持
- [x] 4.2.1 在 start 命令中添加内置任务处理
- [x] 4.2.2 在 stop 命令中添加内置任务处理
- [x] 4.2.3 在 restart 命令中添加内置任务处理
- [x] 4.2.4 在 info 命令中添加内置任务信息显示
- [x] 4.2.5 在 add/edit/del 命令中添加内置任务保护

### 4.3 需求条件检查
- [x] 4.3.1 实现 needsDaemon 函数检查守护进程需求
- [x] 4.3.2 实现 hasRunningTasks 函数检查运行中任务
- [x] 4.3.3 实现 hasAutoStartTasks 函数检查自动启动任务
- [x] 4.3.4 在相关命令中集成守护进程需求检查
- [ ] 4.3.5 实现守护进程的按需启动逻辑

## 阶段5：错误处理和优化

### 5.1 错误处理机制
- [ ] 5.1.1 实现守护进程启动失败的错误处理
- [ ] 5.1.2 实现守护进程停止失败的错误处理
- [ ] 5.1.3 实现任务重启失败的错误处理
- [ ] 5.1.4 实现状态文件访问失败的错误处理
- [ ] 5.1.5 实现进程检查失败的错误处理

### 5.2 性能优化
- [ ] 5.2.1 优化监控检查间隔配置
- [ ] 5.2.2 实现批量状态更新机制
- [ ] 5.2.3 优化文件 I/O 操作频率
- [ ] 5.2.4 实现内存使用优化
- [ ] 5.2.5 添加性能监控和日志记录

### 5.3 配置管理
- [ ] 5.3.1 添加守护进程监控间隔配置选项
- [ ] 5.3.2 添加重试策略相关配置选项
- [ ] 5.3.3 实现配置文件的热重载支持*
- [ ] 5.3.4 添加守护进程日志级别配置*
- [ ] 5.3.5 实现配置验证和默认值处理

## 阶段6：测试和验证

### 6.1 单元测试
- [ ] 6.1.1 编写 DaemonManager 单元测试
- [ ] 6.1.2 编写 TaskMonitor 单元测试
- [ ] 6.1.3 编写 BuiltinTaskHandler 单元测试
- [ ] 6.1.4 编写 ProcessChecker 单元测试
- [ ] 6.1.5 编写 FileStateManager 单元测试

### 6.2 集成测试
- [ ] 6.2.1 编写守护进程完整生命周期测试
- [ ] 6.2.2 编写自动重启功能集成测试
- [ ] 6.2.3 编写内置任务保护功能测试
- [ ] 6.2.4 编写并发访问安全性测试
- [ ] 6.2.5 编写错误恢复机制测试

### 6.3 正确性属性测试
- [ ] 6.3.1 编写内置任务保护属性测试
- [ ] 6.3.2 编写守护进程唯一性属性测试
- [ ] 6.3.3 编写进程分离正确性属性测试
- [ ] 6.3.4 编写自动重启条件属性测试
- [ ] 6.3.5 编写状态一致性属性测试
- [ ] 6.3.6 编写重试计数正确性属性测试
- [ ] 6.3.7 编写守护进程监控持续性属性测试

### 6.4 性能和稳定性测试
- [ ] 6.4.1 编写长时间运行稳定性测试
- [ ] 6.4.2 编写大量任务场景性能测试
- [ ] 6.4.3 编写资源使用监控测试
- [ ] 6.4.4 编写异常情况恢复测试
- [ ] 6.4.5 编写平台兼容性测试

## 阶段7：文档和部署

### 7.1 代码文档
- [ ] 7.1.1 完善守护进程相关代码注释
- [ ] 7.1.2 编写 API 文档和使用示例
- [ ] 7.1.3 更新项目架构文档
- [ ] 7.1.4 编写故障排除指南
- [ ] 7.1.5 更新配置文件示例和说明

### 7.2 用户文档
- [ ] 7.2.1 更新用户使用手册
- [ ] 7.2.2 编写守护进程功能说明
- [ ] 7.2.3 编写自动重启配置指南
- [ ] 7.2.4 更新命令行帮助信息
- [ ] 7.2.5 编写迁移和升级指南

### 7.3 部署准备
- [ ] 7.3.1 验证向后兼容性
- [ ] 7.3.2 准备数据迁移脚本*
- [ ] 7.3.3 编写部署检查清单
- [ ] 7.3.4 准备回滚方案*
- [ ] 7.3.5 完成最终集成测试

## 任务依赖关系

### 关键路径
1. 阶段1 → 阶段2 → 阶段3 → 阶段4
2. 阶段5 可与阶段4 并行进行
3. 阶段6 依赖前面所有阶段完成
4. 阶段7 可与阶段6 并行进行

### 重要依赖
- 2.1 依赖 1.1, 1.2, 1.3
- 3.1 依赖 2.1, 2.2
- 3.2 依赖 3.1
- 4.1, 4.2 依赖 2.1, 3.1
- 6.3 依赖所有功能实现完成

## 验收标准映射

每个任务都对应需求文档中的特定验收标准：

- **AC1**: 任务 1.3.x, 4.2.5
- **AC2**: 任务 4.2.1-4.2.4
- **AC3**: 任务 1.2.x, 2.1.2
- **AC4**: 任务 2.2.x, 2.1.4
- **AC5**: 任务 4.1.x, 4.3.x
- **AC6**: 任务 2.3.x
- **AC7**: 任务 1.1.x
- **AC8**: 任务 4.1.2, 4.1.3, 3.2.x
- **AC9**: 任务 3.1.x, 3.2.x
- **AC10**: 任务 5.1.x

## 估算说明

- 总任务数：105个任务
- 必需任务：95个
- 可选任务：10个（标记为*）
- 预估工作量：每个任务平均0.5-2天
- 总体时间：约8-12周（取决于并行度和复杂性）